<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NSé‡Šå‹/é£˜é™é€‰æ‹©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            padding: 10px;
            background: #f0f2f5;
            min-height: 100vh;
            font-size: 14px;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 767px) {
            body {
                padding: 5px;
                font-size: 13px;
            }
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 767px) {
            .container {
                padding: 10px;
                border-radius: 6px;
            }
        }
        
        .header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8eaec;
        }
        
        @media (min-width: 768px) {
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .title {
            color: #1a365d;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
        }
        
        @media (max-width: 767px) {
            .title {
                font-size: 1.2rem;
            }
        }
        
        .control-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        @media (min-width: 768px) {
            .control-buttons {
                justify-content: flex-end;
            }
        }
        
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        @media (max-width: 767px) {
            button {
                padding: 6px 10px;
                font-size: 0.85rem;
            }
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        .btn-secondary:hover { background: #4a5568; }
        .btn-success {
            background: #38a169;
            color: white;
        }
        .btn-success:hover { background: #2f855a; }
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        .btn-danger:hover { background: #c53030; }
        .btn-warning {
            background: #d69e2e;
            color: white;
        }
        .btn-warning:hover { background: #b7791f; }
        .btn-info {
            background: #3182ce;
            color: white;
        }
        .btn-info:hover { background: #2c5282; }
        
        .drag-instructions {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 10px;
            padding: 8px;
            background: #f7fafc;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            display: none;
        }
        
        .airport-pairs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            justify-content: center;
        }
        
        @media (max-width: 767px) {
            .airport-pairs {
                padding: 8px;
                gap: 6px;
                justify-content: flex-start;
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        .airport-pair {
            padding: 8px 12px;
            background: white;
            border: 2px solid #38a169;
            border-radius: 6px;
            color: #38a169;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
            max-width: 200px;
        }
        
        @media (max-width: 767px) {
            .airport-pair {
                padding: 6px 10px;
                font-size: 0.9rem;
                min-width: 120px;
                justify-content: center;
            }
        }
        
        .airport-pair:hover {
            background: #38a169;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(56, 161, 105, 0.3);
        }
        .airport-pair.selected {
            background: #38a169;
            color: white;
            border-color: #2f855a;
            box-shadow: 0 0 0 3px rgba(56, 161, 105, 0.2);
        }
        .airport-pair .upload-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            display: none;
        }
        .airport-pair.selected .upload-btn {
            display: block;
        }
        
        .status-bar {
            background: #edf2f7;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        @media (min-width: 768px) {
            .status-bar {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .stats {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        @media (max-width: 767px) {
            .stats {
                gap: 15px;
                flex-wrap: wrap;
                justify-content: space-around;
            }
        }
        
        .stat-item {
            text-align: center;
            min-width: 80px;
        }
        
        @media (max-width: 767px) {
            .stat-item {
                min-width: 70px;
            }
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2d3748;
        }
        
        @media (max-width: 767px) {
            .stat-value {
                font-size: 1.1rem;
            }
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #718096;
            margin-top: 2px;
        }
        
        .selected-alternates {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }
        
        @media (min-width: 768px) {
            .selected-alternates {
                justify-content: flex-end;
            }
        }
        
        .alternate-tag {
            background: #38a169;
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }
        
        .alternate-tag .remove {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            font-size: 1.1rem;
            line-height: 1;
        }
        
        .data-table-container {
            margin-top: 10px;
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 767px) {
            .data-table-container {
                border-radius: 6px;
                margin-left: -5px;
                margin-right: -5px;
                width: calc(100% + 10px);
            }
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
            min-width: 400px;
        }
        
        @media (max-width: 767px) {
            table {
                font-size: 0.85rem;
            }
        }
        
        th {
            background: #2d3748;
            color: white;
            padding: 10px 6px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }
        
        @media (max-width: 767px) {
            th {
                padding: 8px 4px;
                font-size: 0.85rem;
            }
        }
        
        td {
            border: 1px solid #ddd;
            padding: 8px 6px;
            text-align: center;
            transition: background-color 0.2s;
            background: white;
            min-width: 60px;
        }
        
        @media (max-width: 767px) {
            td {
                padding: 6px 4px;
                min-width: 50px;
            }
        }
        
        .release-group td {
            border-bottom: 2px solid #ddd !important;
            background: white;
        }
        .descend-group td {
            border-bottom: 2px solid #ddd !important;
            background: white;
        }
        .group-title {
            font-weight: bold;
            text-align: left;
            padding-left: 15px;
            background: #edf2f7 !important;
            border-bottom: 3px solid #ddd !important;
        }
        
        @media (max-width: 767px) {
            .group-title {
                padding-left: 10px;
            }
        }
        
        .release-group-title {
            color: #2f855a;
        }
        .descend-group-title {
            color: #c53030;
        }
        .group-divider td {
            border-bottom: 3px solid #ddd !important;
            padding: 2px;
            background: #edf2f7;
        }
        .alternate-cell {
            cursor: pointer;
            font-weight: bold;
            color: #2d3748;
            transition: all 0.2s;
            position: relative;
            background: white;
        }
        .alternate-cell:hover {
            background-color: #e6fffa !important;
        }
        .alternate-cell.selected {
            background-color: #c6f6d5 !important;
        }
        .segment-cell {
            background: white;
        }
        .segment-cell.selected {
            background-color: #c6f6d5 !important;
        }
        
        tr:hover td {
            background-color: #f7fafc !important;
        }
        
        .collapse-section {
            margin-top: 20px;
        }
        .collapse-header {
            background: #e2e8f0;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #2d3748;
            font-size: 1rem;
        }
        
        @media (max-width: 767px) {
            .collapse-header {
                padding: 10px 12px;
                font-size: 0.95rem;
            }
        }
        
        .collapse-content {
            padding: 15px;
            background: #f7fafc;
            border-radius: 0 0 6px 6px;
            display: none;
        }
        
        @media (max-width: 767px) {
            .collapse-content {
                padding: 12px;
            }
        }
        
        .collapse-content.active {
            display: block;
        }
        
        /* å¯†ç åŒºåŸŸ */
        .password-section {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        
        @media (max-width: 767px) {
            .password-section {
                padding: 12px;
            }
        }
        
        .password-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }
        
        @media (min-width: 768px) {
            .password-input-group {
                flex-direction: row;
                justify-content: center;
            }
        }
        
        .password-input-group input {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            width: 200px;
            font-size: 1rem;
            text-align: center;
            letter-spacing: 2px;
        }
        
        @media (max-width: 767px) {
            .password-input-group input {
                width: 100%;
                max-width: 200px;
            }
        }
        
        /* æ•°æ®ç®¡ç†å†…å®¹ */
        .locked-content {
            display: none;
        }
        .unlocked-content {
            display: block;
        }
        
        /* æœºåœºå¯¹ç®¡ç† */
        .pair-management {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .pair-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        @media (min-width: 768px) {
            .pair-input-group {
                flex-direction: row;
            }
        }
        
        .pair-input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .pairs-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            background: white;
        }
        
        .pair-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 8px 10px;
            background: white;
            border-radius: 4px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        
        @media (min-width: 768px) {
            .pair-item {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 0;
            }
        }
        
        .pair-item:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }
        .pair-item.dragging {
            opacity: 0.5;
            background: #ebf8ff;
            border-style: dashed;
        }
        .pair-item .drag-handle {
            cursor: move;
            color: #718096;
            font-size: 1.2rem;
            margin-right: 10px;
            user-select: none;
        }
        .pair-item .pair-info {
            flex: 1;
            display: flex;
            align-items: center;
        }
        .pair-item .pair-actions {
            display: flex;
            gap: 5px;
        }
        
        .sort-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        @media (min-width: 768px) {
            .sort-controls {
                flex-direction: row;
                align-items: center;
            }
        }
        
        /* æ‹–æ‹½æ‰‹æŸ„ */
        .airport-pair .drag-handle {
            cursor: move;
            margin-right: 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
            user-select: none;
        }
        .airport-pair:hover .drag-handle {
            opacity: 1;
        }
        .airport-pair.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .airport-pair.drag-over {
            border-style: dashed;
            border-color: #3182ce;
        }
        
        /* æ•°æ®åŒæ­¥åŒºåŸŸ */
        .sync-section {
            margin-top: 20px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .sync-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .sync-options button {
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
        }
        
        @media (max-width: 767px) {
            .sync-options button {
                padding: 8px 12px;
            }
        }
        
        /* å¤‡ä»½æé†’ */
        .backup-note {
            background: #fffaf0;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #fed7d7;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #9c4221;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        @media (min-width: 768px) {
            .backup-note {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        /* æ¨¡æ¿åŒºåŸŸ */
        .template-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #ddd;
        }
        
        .template-preview {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            margin-top: 10px;
            overflow-x: auto;
        }
        
        .template-header {
            color: #3182ce;
            font-weight: bold;
        }
        .template-row {
            color: #2d3748;
        }
        
        .download-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        @media (min-width: 768px) {
            .download-buttons {
                flex-direction: row;
            }
        }
        
        .template-note {
            background: #f0fff4;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #2f855a;
            border: 1px solid #ddd;
        }
        
        /* æ•°æ®å¯¼å…¥åŒºåŸŸ */
        .import-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #ddd;
            margin-bottom: 15px;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        @media (max-width: 767px) {
            .upload-area {
                padding: 15px;
            }
        }
        
        .upload-area:hover {
            border-color: #3182ce;
            background: #f0f7ff;
        }
        .upload-area.drag-over {
            border-color: #38a169;
            background: #f0fff4;
        }
        .upload-icon {
            font-size: 40px;
            color: #718096;
            margin-bottom: 10px;
        }
        
        @media (max-width: 767px) {
            .upload-icon {
                font-size: 32px;
            }
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        /* æ‰¹é‡æ“ä½œåŒºåŸŸ */
        .batch-operations {
            margin-top: 15px;
        }
        
        .batch-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        @media (min-width: 768px) {
            .batch-buttons {
                flex-direction: row;
            }
        }
        
        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #38a169;
            color: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            max-width: 300px;
            word-break: break-word;
        }
        
        @media (max-width: 767px) {
            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                text-align: center;
            }
        }
        
        .notification.show {
            display: flex;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @media (max-width: 767px) {
            @keyframes slideIn {
                from { transform: translateY(-20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        }
        
        /* ç¨‹åºæŒ‡ç¤ºå™¨ */
        .program-indicator {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 8px;
        }
        .release-indicator {
            background: #c6f6d5;
            color: #2f855a;
        }
        .descend-indicator {
            background: #fed7d7;
            color: #c53030;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 10px;
        }
        .modal-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        @media (max-width: 767px) {
            .modal-content {
                padding: 12px;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-title {
            margin: 0;
            color: #2d3748;
            font-size: 1.2rem;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
        }
        .data-info {
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #4a5568;
        }
        .backup-textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 15px;
        }
        
        @media (min-width: 768px) {
            .backup-textarea {
                height: 300px;
            }
        }
        
        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        @media (min-width: 768px) {
            .modal-actions {
                flex-direction: row;
                justify-content: flex-end;
            }
        }
        
        /* è®¾å¤‡æ£€æµ‹æç¤º */
        .device-hint {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #3182ce;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            opacity: 0.7;
            z-index: 999;
            display: none;
        }
        
        @media (max-width: 767px) {
            .device-hint {
                display: block;
            }
        }
        
        @media (min-width: 768px) and (max-width: 1024px) {
            .device-hint {
                display: block;
                background: #38a169;
            }
        }
        
        /* åˆ—æ•°æŒ‡ç¤ºå™¨ */
        .columns-info {
            background: #e6fffa;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #2f855a;
            border: 1px solid #c6f6d5;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .columns-count {
            background: #38a169;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        /* æ–°çš„ALTNåˆ—åæ ·å¼ */
        .aln-header {
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }
        
        @media (max-width: 767px) {
            .aln-header {
                font-size: 0.8rem;
                letter-spacing: 0.3px;
            }
        }
    </style>
</head>
<body>
    <div class="device-hint" id="deviceHint">
        å½“å‰è®¾å¤‡: <span id="deviceType">ç”µè„‘</span>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="title">NSé‡Šå‹/é£˜é™é€‰æ‹©</div>
            <div class="control-buttons">
                <button class="btn-info" onclick="togglePairOrderMode()" id="orderModeBtn">
                    <span class="icon">ğŸ”„</span>
                    <span class="text">è°ƒæ•´é¡ºåº</span>
                </button>
                <button class="btn-secondary" onclick="clearAllHighlights()">
                    <span class="icon">ğŸ—‘ï¸</span>
                    <span class="text">æ¸…é™¤é«˜äº®</span>
                </button>
            </div>
        </div>
        
        <div class="drag-instructions" id="dragInstructions">
            <strong>ğŸ“‹ æ‹–æ‹½æ’åºè¯´æ˜ï¼š</strong>
            <ul>
                <li>æ‹–åŠ¨æœºåœºå¯¹æŒ‰é’®å¯è°ƒæ•´æ˜¾ç¤ºé¡ºåº</li>
                <li>åœ¨æ•°æ®ç®¡ç†åˆ—è¡¨ä¸­ä¹Ÿæ”¯æŒæ‹–æ‹½æ’åº</li>
                <li>ç‚¹å‡»"å®Œæˆæ’åº"æŒ‰é’®ä¿å­˜é¡ºåº</li>
            </ul>
        </div>
        
        <div id="airportPairsContainer" class="airport-pairs">
            <!-- æœºåœºå¯¹ä¼šåŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
        
        <div class="status-bar">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalSegments">0</div>
                    <div class="stat-label">å½“å‰èˆªæ®µæ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="selectedAlternatesCount">0</div>
                    <div class="stat-label">å·²é€‰å¤‡é™åœº</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentPairName">-</div>
                    <div class="stat-label">å½“å‰æœºåœºå¯¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="maxAlternatesCount">5</div>
                    <div class="stat-label">æœ€å¤§å¤‡é™åœºæ•°</div>
                </div>
            </div>
            <div class="selected-alternates" id="selectedAlternatesContainer">
                <!-- å·²é€‰å¤‡é™åœºæ ‡ç­¾ä¼šåŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
        
        <div class="data-table-container">
            <div id="columnsInfo" class="columns-info" style="display: none;">
                <span>ğŸ“Š å½“å‰è¡¨æ ¼åˆ—æ•°:</span>
                <span class="columns-count" id="currentColumnsCount">5</span>
                <span>å¤‡é™åœºåˆ—ï¼ˆæ ¹æ®ä¸Šä¼ æ•°æ®åŠ¨æ€è°ƒæ•´ï¼‰</span>
            </div>
            
            <table id="dataTable">
                <thead id="tableHeader">
                    <!-- è¡¨å¤´ä¼šåŠ¨æ€ç”Ÿæˆ -->
                </thead>
                <tbody id="tableBody">
                    <!-- æ•°æ®è¡Œå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        
        <div class="collapse-section">
            <div class="collapse-header" onclick="toggleCollapse('dataManage')">
                æ•°æ®ç®¡ç†
                <span id="collapseIcon">â–¼</span>
            </div>
            <div class="collapse-content" id="dataManage">
                <!-- å¯†ç éªŒè¯åŒºåŸŸ -->
                <div class="password-section" id="passwordSection">
                    <h4 style="margin-bottom: 15px; color: #2d3748;">ğŸ” è¯·è¾“å…¥å¯†ç è®¿é—®æ•°æ®ç®¡ç†åŠŸèƒ½ (å¯†ç :28420)</h4>
                    <div class="password-input-group">
                        <input type="password" id="passwordInput" placeholder="è¾“å…¥å¯†ç " maxlength="5">
                        <button class="btn-success" onclick="checkPassword()">éªŒè¯å¯†ç </button>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85rem; color: #718096;">
                        æç¤ºï¼šè¾“å…¥æ­£ç¡®å¯†ç åæ‰èƒ½è®¿é—®æ•°æ®ç®¡ç†åŠŸèƒ½
                    </div>
                </div>
                
                <!-- æ•°æ®ç®¡ç†å†…å®¹ (é»˜è®¤éšè—ï¼Œå¯†ç éªŒè¯åæ˜¾ç¤º) -->
                <div id="dataManageContent" class="locked-content">
                    <!-- æœºåœºå¯¹ç®¡ç† -->
                    <div class="pair-management">
                        <h4 style="margin-bottom: 10px; color: #2d3748;">æœºåœºå¯¹ç®¡ç†</h4>
                        <div class="pair-input-group">
                            <input type="text" id="newAirportPair" placeholder="ä¾‹å¦‚ï¼šçŸ³å®¶åº„-å¤§å…´" style="flex: 2;">
                            <button class="btn-success" onclick="addAirportPair()">æ·»åŠ æœºåœºå¯¹</button>
                            <button class="btn-warning" onclick="addSamplePairs()">æ·»åŠ ç¤ºä¾‹æœºåœºå¯¹</button>
                        </div>
                        
                        <div class="sort-controls" id="listSortControls" style="display: none;">
                            <button class="btn-info" onclick="savePairOrder()">
                                <span class="icon">ğŸ’¾</span>
                                <span class="text">ä¿å­˜å½“å‰é¡ºåº</span>
                            </button>
                            <button class="btn-secondary" onclick="cancelPairOrder()">
                                <span class="icon">âŒ</span>
                                <span class="text">å–æ¶ˆæ’åº</span>
                            </button>
                        </div>
                        
                        <div id="pairsList" class="pairs-list">
                            <!-- æœºåœºå¯¹åˆ—è¡¨ä¼šåŠ¨æ€æ˜¾ç¤º -->
                        </div>
                    </div>
                    
                    <!-- æ•°æ®åŒæ­¥åŠŸèƒ½ -->
                    <div class="sync-section">
                        <h4 style="margin-bottom: 15px; color: #2d3748;">ğŸ”„ å¤šè®¾å¤‡æ•°æ®åŒæ­¥</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <p style="color: #4a5568; margin-bottom: 10px;">
                                <strong>æ³¨æ„ï¼š</strong>æœ¬å·¥å…·æ•°æ®é»˜è®¤å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œä¸åŒè®¾å¤‡é—´éœ€è¦æ‰‹åŠ¨åŒæ­¥ã€‚
                            </p>
                            
                            <div class="sync-options">
                                <button class="btn-success" onclick="exportAllData()">
                                    <span class="icon">ğŸ“¤</span>
                                    <span class="text">å¯¼å‡ºæ‰€æœ‰æ•°æ® (JSONæ–‡ä»¶)</span>
                                    <small class="recommended">æ¨èä½¿ç”¨</small>
                                </button>
                                
                                <button class="btn-warning" onclick="importData()">
                                    <span class="icon">ğŸ“¥</span>
                                    <span class="text">å¯¼å…¥æ•°æ®æ–‡ä»¶</span>
                                    <small class="format">.jsonæ ¼å¼</small>
                                </button>
                                
                                <button class="btn-info" onclick="generateBackupCode()">
                                    <span class="icon">ğŸ“‹</span>
                                    <span class="text">ç”Ÿæˆå¤‡ä»½ä»£ç </span>
                                    <small class="format">æ–‡æœ¬æ ¼å¼</small>
                                </button>
                                
                                <button class="btn-secondary" onclick="importFromText()">
                                    <span class="icon">ğŸ“</span>
                                    <span class="text">ä»æ–‡æœ¬å¯¼å…¥</span>
                                    <small class="format">ç²˜è´´å¤‡ä»½ä»£ç </small>
                                </button>
                                
                                <div style="margin-top: 10px; padding: 10px; background: #fff; border-radius: 6px; border: 1px solid #e2e8f0;">
                                    <h5 style="margin-bottom: 8px; color: #2d3748;">ğŸ’¡ åŒæ­¥è¯´æ˜</h5>
                                    <ol style="margin: 0; padding-left: 20px; font-size: 0.9rem; color: #4a5568;">
                                        <li>åœ¨Aç”µè„‘ï¼šç‚¹å‡»"å¯¼å‡ºæ‰€æœ‰æ•°æ®"ä¸‹è½½æ–‡ä»¶</li>
                                        <li>å°†æ–‡ä»¶å‘é€åˆ°Bç”µè„‘ï¼ˆå¾®ä¿¡ã€é‚®ä»¶ç­‰ï¼‰</li>
                                        <li>åœ¨Bç”µè„‘ï¼šç‚¹å‡»"å¯¼å…¥æ•°æ®æ–‡ä»¶"é€‰æ‹©æ–‡ä»¶</li>
                                        <li>æ‰€æœ‰æ•°æ®å°†åŒæ­¥åˆ°Bç”µè„‘</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="backup-note">
                        <div>
                            <strong>ğŸ’¾ å¤‡ä»½æé†’ï¼š</strong>
                            <span id="lastBackupInfo">ä»æœªå¤‡ä»½</span>
                        </div>
                        <button onclick="exportAllData()" style="padding: 6px 12px; background: #38a169; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                            ç«‹å³å¤‡ä»½
                        </button>
                    </div>
                    
                    <!-- æ¨¡æ¿ä¸‹è½½ -->
                    <div class="template-section">
                        <h4 style="margin-bottom: 15px; color: #2d3748;">æ•°æ®å¯¼å…¥æ¨¡æ¿</h4>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
                                <span class="program-indicator release-indicator">é‡Šå‹æ¨¡æ¿</span>
                                <span>CSVæ ¼å¼ï¼ˆUTF-8ç¼–ç ï¼‰ï¼šæ”¯æŒ1-10ä¸ªå¤‡é™åœº</span>
                            </div>
                            <div class="template-preview">
                                <div class="template-header">èˆªæ®µ,ALTN1,ALTN2,ALTN3,ALTN4,ALTN5,ALTN6,ALTN7,ALTN8,ALTN9,ALTN10</div>
                                <div class="template-row">èˆªæ®µ-01,PEK,SHA,CAN,SZX,XIY,CTU,KMG,URC,HRB,DLC</div>
                                <div class="template-row">èˆªæ®µ-02,PVG,CTU,KMG,URC,HRB,SHA,PEK,CAN,SZX,XIY</div>
                                <div class="template-row">èˆªæ®µ-03,CAN,SZX,CTU,XIY,TAO,PVG,KMG,URC,HRB,PEK</div>
                            </div>
                            
                            <div style="margin-bottom: 20px; margin-top: 20px;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
                                    <span class="program-indicator descend-indicator">é£˜é™æ¨¡æ¿</span>
                                    <span>CSVæ ¼å¼ï¼ˆUTF-8ç¼–ç ï¼‰ï¼šæ”¯æŒ1-10ä¸ªå¤‡é™åœº</span>
                                </div>
                                <div class="template-preview">
                                    <div class="template-header">èˆªæ®µ,ALTN1,ALTN2,ALTN3,ALTN4,ALTN5,ALTN6,ALTN7,ALTN8,ALTN9,ALTN10</div>
                                    <div class="template-row">èˆªæ®µ-04,SZX,CTU,KMG,URC,HRB,PEK,SHA,CAN,XIY,TAO</div>
                                    <div class="template-row">èˆªæ®µ-05,CTU,PEK,SHA,CAN,SZX,XIY,KMG,URC,HRB,PVG</div>
                                    <div class="template-row">èˆªæ®µ-06,XIY,CKG,KWE,WUH,CSX,CTU,SZX,CAN,PEK,SHA</div>
                                </div>
                            </div>
                            
                            <div class="download-buttons">
                                <button class="btn-success" onclick="downloadReleaseTemplate()">
                                    <span class="icon">ğŸ“¥</span>
                                    <span class="text">ä¸‹è½½é‡Šå‹æ¨¡æ¿</span>
                                </button>
                                <button class="btn-danger" onclick="downloadDescendTemplate()">
                                    <span class="icon">ğŸ“¥</span>
                                    <span class="text">ä¸‹è½½é£˜é™æ¨¡æ¿</span>
                                </button>
                                <button class="btn-warning" onclick="downloadCombinedTemplate()">
                                    <span class="icon">ğŸ“¥</span>
                                    <span class="text">ä¸‹è½½å®Œæ•´æ¨¡æ¿</span>
                                </button>
                            </div>
                            
                            <div class="template-note">
                                <strong>ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                                1. æ”¯æŒ1-10ä¸ªå¤‡é™åœºåˆ—ï¼Œç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«åˆ—æ•°<br>
                                2. ä¸¥æ ¼æŒ‰ç…§æ¨¡æ¿æ ¼å¼å¡«å†™ï¼Œä¸è¦ä¿®æ”¹è¡¨å¤´<br>
                                3. ä¿å­˜ä¸ºCSVæ ¼å¼ï¼ˆUTF-8ç¼–ç ï¼‰åå¯¼å…¥<br>
                                4. ç³»ç»Ÿä¼šæ ¹æ®æ‰€æœ‰æ•°æ®ä¸­çš„æœ€å¤§å¤‡é™åœºæ•°åŠ¨æ€è°ƒæ•´è¡¨æ ¼åˆ—æ•°
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ•°æ®å¯¼å…¥ -->
                    <div class="import-section">
                        <h4 style="margin-bottom: 15px; color: #2d3748;">æ•°æ®å¯¼å…¥</h4>
                        
                        <div class="upload-area" id="uploadArea" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" ondragleave="handleDragLeave(event)">
                            <div class="upload-icon">ğŸ“</div>
                            <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 5px;">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                            <div style="font-size: 0.9rem; color: #718096; margin-bottom: 10px;">
                                æˆ–ç‚¹å‡»é€‰æ‹©CSVæ–‡ä»¶ï¼ˆUTF-8ç¼–ç ï¼‰
                            </div>
                            <div class="file-input-wrapper">
                                <button class="btn-success">é€‰æ‹©CSVæ–‡ä»¶</button>
                                <input type="file" id="fileInput" accept=".csv" multiple onchange="handleFileSelect()">
                            </div>
                            <div style="font-size: 0.85rem; color: #718096; margin-top: 15px;">
                                <strong>æ³¨æ„ï¼š</strong>æ”¯æŒ1-10ä¸ªå¤‡é™åœºåˆ—ï¼Œç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«<br>
                                å¤‡é™åœºåˆ—åæ ¼å¼ï¼šALTN1, ALTN2, ALTN3...<br>
                                æ–‡ä»¶åå»ºè®®ï¼š<span style="color: #38a169;">[æœºåœºå¯¹]_[ç¨‹åº].csv</span><br>
                                ä¾‹å¦‚ï¼šçŸ³å®¶åº„-å¤§å…´_é‡Šå‹.csv
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn-danger" onclick="clearCurrentPairData()" style="width: 100%;">
                                <span class="icon">ğŸ—‘ï¸</span>
                                <span class="text">æ¸…ç©ºå½“å‰æœºåœºå¯¹æ•°æ®</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ‰¹é‡æ“ä½œ -->
                    <div class="batch-operations">
                        <h4 style="margin-bottom: 10px; color: #2d3748;">æ‰¹é‡æ“ä½œ</h4>
                        <div class="batch-buttons">
                            <button class="btn-success" onclick="loadAllSampleData()">
                                <span class="icon">ğŸ“‹</span>
                                <span class="text">åŠ è½½æ‰€æœ‰ç¤ºä¾‹æ•°æ®</span>
                            </button>
                            <button class="btn-danger" onclick="clearAllData()">
                                <span class="icon">ğŸ—‘ï¸</span>
                                <span class="text">æ¸…ç©ºæ‰€æœ‰æœºåœºå¯¹æ•°æ®</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é€šçŸ¥ -->
    <div class="notification" id="notification">
        <span id="notificationMessage">æ“ä½œæˆåŠŸ</span>
    </div>

    <script>
        // å…¨å±€æ•°æ®å­˜å‚¨ç»“æ„
        let allData = {};
        let airportPairs = [];
        let currentPair = null;
        let selectedAlternates = new Set();
        
        // å…¨å±€æœ€å¤§å¤‡é™åœºæ•°é‡
        let maxAlternatesCount = 5; // é»˜è®¤5ä¸ªï¼Œä½†ä¼šè‡ªåŠ¨è°ƒæ•´
        
        // æ‹–æ‹½æ’åºç›¸å…³å˜é‡
        let isReorderMode = false;
        let draggedItem = null;
        let draggedItemIndex = -1;
        let originalPairOrder = [];
        
        // å¯†ç éªŒè¯çŠ¶æ€
        let passwordVerified = false;
        const PASSWORD = "28420";
        
        // æ•°æ®ç‰ˆæœ¬
        const DATA_VERSION = "3.0"; // å‡çº§ç‰ˆæœ¬ä»¥æ”¯æŒè‡ªé€‚åº”åˆ—æ•°
        
        // è®¾å¤‡æ£€æµ‹
        function detectDevice() {
            const width = window.innerWidth;
            let deviceType = "ç”µè„‘";
            
            if (width < 768) {
                deviceType = "æ‰‹æœº";
            } else if (width >= 768 && width <= 1024) {
                deviceType = "å¹³æ¿";
            }
            
            document.getElementById('deviceType').textContent = deviceType;
            return deviceType;
        }
        
        // è°ƒæ•´ç•Œé¢é€‚åº”è®¾å¤‡
        function adjustUIForDevice() {
            const device = detectDevice();
            const isMobile = device === "æ‰‹æœº";
            
            // è°ƒæ•´è¡¨æ ¼æ»šåŠ¨
            if (isMobile) {
                // æ‰‹æœºç«¯ä¼˜åŒ–
                document.body.style.fontSize = '13px';
                // éšè—éƒ¨åˆ†æŒ‰é’®æ–‡å­—ï¼Œåªæ˜¾ç¤ºå›¾æ ‡
                const buttons = document.querySelectorAll('button .text');
                buttons.forEach(btn => {
                    if (btn.textContent.includes('è°ƒæ•´é¡ºåº')) {
                        btn.textContent = 'é¡ºåº';
                    } else if (btn.textContent.includes('æ¸…é™¤é«˜äº®')) {
                        btn.textContent = 'æ¸…é™¤';
                    }
                });
            }
        }
        
        // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
        function initSampleData() {
            // åˆå§‹åŒ–ç¤ºä¾‹æœºåœºå¯¹
            airportPairs = ['çŸ³å®¶åº„-å¤§å…´', 'å¤§å…´-ä¹Œé²æœ¨é½', 'ä¹Œé²æœ¨é½-å¤§å…´', 'åŒ—äº¬-ä¸Šæµ·', 'ä¸Šæµ·-å¹¿å·'];
            
            // ä¸ºæ¯ä¸ªæœºåœºå¯¹åˆå§‹åŒ–ç©ºæ•°æ®
            airportPairs.forEach(pair => {
                allData[pair] = {
                    release: [],
                    descend: [],
                    selectedAlternates: new Set(),
                    maxAlternates: 5, // è®°å½•æ¯ä¸ªæœºåœºå¯¹çš„æœ€å¤§å¤‡é™åœºæ•°
                    nextId: 1
                };
            });
            
            // ä¸ºç¬¬ä¸€ä¸ªæœºåœºå¯¹æ·»åŠ ç¤ºä¾‹æ•°æ®
            if (airportPairs.length > 0) {
                currentPair = airportPairs[0];
                loadPairSampleData(currentPair);
            }
            
            renderAirportPairs();
            if (currentPair) {
                // è®¡ç®—å…¨å±€æœ€å¤§å¤‡é™åœºæ•°
                calculateMaxAlternatesCount();
                renderTableHeader();
                renderTable();
                updateStats();
            }
            saveAllData();
            updateLastBackupInfo();
            showNotification('ç¤ºä¾‹æ•°æ®å·²åˆå§‹åŒ–');
        }
        
        // è®¡ç®—å…¨å±€æœ€å¤§å¤‡é™åœºæ•°
        function calculateMaxAlternatesCount() {
            let maxCount = 5; // é»˜è®¤æœ€å°å€¼
            
            Object.keys(allData).forEach(pair => {
                const pairData = allData[pair];
                let pairMax = 0;
                
                // æ£€æŸ¥é‡Šå‹æ•°æ®
                pairData.release.forEach(row => {
                    // è®¡ç®—è¯¥è¡Œå®é™…æœ‰æ•ˆçš„å¤‡é™åœºæ•°é‡
                    let count = 0;
                    for (let i = 1; i <= 10; i++) {
                        const key = `alternate${i}`;
                        if (row[key] && row[key].trim() !== '') {
                            count = i; // æ›´æ–°æœ€å¤§åˆ—æ•°
                        }
                    }
                    if (count > pairMax) pairMax = count;
                });
                
                // æ£€æŸ¥é£˜é™æ•°æ®
                pairData.descend.forEach(row => {
                    let count = 0;
                    for (let i = 1; i <= 10; i++) {
                        const key = `alternate${i}`;
                        if (row[key] && row[key].trim() !== '') {
                            count = i;
                        }
                    }
                    if (count > pairMax) pairMax = count;
                });
                
                // æ›´æ–°è¯¥æœºåœºå¯¹çš„æœ€å¤§å¤‡é™åœºæ•°
                allData[pair].maxAlternates = Math.max(5, pairMax);
                
                // æ›´æ–°å…¨å±€æœ€å¤§å€¼
                if (allData[pair].maxAlternates > maxCount) {
                    maxCount = allData[pair].maxAlternates;
                }
            });
            
            maxAlternatesCount = maxCount;
            document.getElementById('maxAlternatesCount').textContent = maxAlternatesCount;
            document.getElementById('currentColumnsCount').textContent = maxAlternatesCount;
            
            // æ˜¾ç¤ºåˆ—æ•°ä¿¡æ¯
            const columnsInfo = document.getElementById('columnsInfo');
            if (maxAlternatesCount > 5) {
                columnsInfo.style.display = 'flex';
            } else {
                columnsInfo.style.display = 'none';
            }
            
            return maxCount;
        }
        
        // æ£€æŸ¥å¯†ç 
        function checkPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const inputPassword = passwordInput.value.trim();
            
            if (inputPassword === PASSWORD) {
                passwordVerified = true;
                // ä¿å­˜éªŒè¯çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('nsPasswordVerified', 'true');
                localStorage.setItem('nsPasswordTimestamp', Date.now().toString());
                
                // æ˜¾ç¤ºæ•°æ®ç®¡ç†å†…å®¹ï¼Œéšè—å¯†ç åŒºåŸŸ
                document.getElementById('passwordSection').style.display = 'none';
                document.getElementById('dataManageContent').classList.remove('locked-content');
                document.getElementById('dataManageContent').classList.add('unlocked-content');
                
                passwordInput.value = '';
                showNotification('å¯†ç éªŒè¯æˆåŠŸï¼Œå·²è§£é”æ•°æ®ç®¡ç†åŠŸèƒ½');
            } else {
                passwordInput.value = '';
                passwordInput.focus();
                showNotification('å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥', 'error');
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»éªŒè¯è¿‡å¯†ç 
        function checkPasswordFromStorage() {
            const verified = localStorage.getItem('nsPasswordVerified');
            const timestamp = localStorage.getItem('nsPasswordTimestamp');
            
            if (verified === 'true' && timestamp) {
                // æ£€æŸ¥æ˜¯å¦åœ¨24å°æ—¶å†…ï¼ˆ86400000æ¯«ç§’ï¼‰
                const now = Date.now();
                const timeDiff = now - parseInt(timestamp);
                
                if (timeDiff < 86400000) { // 24å°æ—¶å†…
                    passwordVerified = true;
                    document.getElementById('passwordSection').style.display = 'none';
                    document.getElementById('dataManageContent').classList.remove('locked-content');
                    document.getElementById('dataManageContent').classList.add('unlocked-content');
                    return true;
                } else {
                    // è¶…è¿‡24å°æ—¶ï¼Œéœ€è¦é‡æ–°éªŒè¯
                    localStorage.removeItem('nsPasswordVerified');
                    localStorage.removeItem('nsPasswordTimestamp');
                }
            }
            return false;
        }
        
        // åŠ è½½æœºåœºå¯¹çš„ç¤ºä¾‹æ•°æ®
        function loadPairSampleData(pairName) {
            if (!allData[pairName]) {
                allData[pairName] = {
                    release: [],
                    descend: [],
                    selectedAlternates: new Set(),
                    maxAlternates: 5,
                    nextId: 1
                };
            }
            
            // é‡Šå‹ç¤ºä¾‹æ•°æ® - å¢åŠ åˆ°7ä¸ªå¤‡é™åœºä½œä¸ºç¤ºä¾‹
            allData[pairName].release = [
                { 
                    id: 1, 
                    segment: `${pairName}-é‡Šå‹-01`, 
                    alternate1: 'PEK', alternate2: 'SHA', alternate3: 'CAN', 
                    alternate4: 'SZX', alternate5: 'XIY', alternate6: 'CTU', 
                    alternate7: 'KMG', alternate8: '', alternate9: '', alternate10: ''
                },
                { 
                    id: 2, 
                    segment: `${pairName}-é‡Šå‹-02`, 
                    alternate1: 'PVG', alternate2: 'CTU', alternate3: 'KMG', 
                    alternate4: 'URC', alternate5: 'HRB', alternate6: 'SHA', 
                    alternate7: 'PEK', alternate8: 'CAN', alternate9: 'SZX', alternate10: 'XIY'
                },
                { 
                    id: 3, 
                    segment: `${pairName}-é‡Šå‹-03`, 
                    alternate1: 'CAN', alternate2: 'SZX', alternate3: 'CTU', 
                    alternate4: 'XIY', alternate5: 'TAO', alternate6: 'PVG', 
                    alternate7: 'KMG', alternate8: 'URC', alternate9: 'HRB', alternate10: 'PEK'
                }
            ];
            
            // é£˜é™ç¤ºä¾‹æ•°æ® - å¢åŠ åˆ°8ä¸ªå¤‡é™åœºä½œä¸ºç¤ºä¾‹
            allData[pairName].descend = [
                { 
                    id: 4, 
                    segment: `${pairName}-é£˜é™-01`, 
                    alternate1: 'SZX', alternate2: 'CTU', alternate3: 'KMG', 
                    alternate4: 'URC', alternate5: 'HRB', alternate6: 'PEK', 
                    alternate7: 'SHA', alternate8: 'CAN', alternate9: 'XIY', alternate10: 'TAO'
                },
                { 
                    id: 5, 
                    segment: `${pairName}-é£˜é™-02`, 
                    alternate1: 'CTU', alternate2: 'PEK', alternate3: 'SHA', 
                    alternate4: 'CAN', alternate5: 'SZX', alternate6: 'XIY', 
                    alternate7: 'KMG', alternate8: 'URC', alternate9: 'HRB', alternate10: 'PVG'
                },
                { 
                    id: 6, 
                    segment: `${pairName}-é£˜é™-03`, 
                    alternate1: 'XIY', alternate2: 'CKG', alternate3: 'KWE', 
                    alternate4: 'WUH', alternate5: 'CSX', alternate6: 'CTU', 
                    alternate7: 'SZX', alternate8: 'CAN', alternate9: 'PEK', alternate10: 'SHA'
                }
            ];
            
            allData[pairName].nextId = 7;
            allData[pairName].maxAlternates = 10; // ç¤ºä¾‹æ•°æ®ä¸­æœ‰10ä¸ªå¤‡é™åœº
        }
        
        // æ¸²æŸ“è¡¨æ ¼è¡¨å¤´ï¼ˆæ ¹æ®æœ€å¤§å¤‡é™åœºæ•°é‡åŠ¨æ€ç”Ÿæˆï¼‰
        function renderTableHeader() {
            const tableHeader = document.getElementById('tableHeader');
            if (!tableHeader) return;
            
            let headerHTML = '<tr>';
            headerHTML += '<th width="20%">èˆªæ®µ</th>';
            
            // æ ¹æ®æœ€å¤§å¤‡é™åœºæ•°é‡ç”Ÿæˆè¡¨å¤´ - ä½¿ç”¨ALTNæ ¼å¼
            const segmentWidth = 20;
            const alternateWidth = (100 - segmentWidth) / maxAlternatesCount;
            
            for (let i = 1; i <= maxAlternatesCount; i++) {
                headerHTML += `<th width="${alternateWidth}%" class="aln-header">ALTN${i}</th>`;
            }
            
            headerHTML += '</tr>';
            tableHeader.innerHTML = headerHTML;
        }
        
        // æ¸²æŸ“æœºåœºå¯¹æŒ‰é’®
        function renderAirportPairs() {
            const container = document.getElementById('airportPairsContainer');
            container.innerHTML = '';
            
            airportPairs.forEach((pair, index) => {
                const pairElement = document.createElement('div');
                pairElement.className = `airport-pair ${currentPair === pair ? 'selected' : ''} ${isReorderMode ? 'reorder-mode' : ''}`;
                pairElement.setAttribute('data-index', index);
                pairElement.setAttribute('data-pair', pair);
                
                if (isReorderMode) {
                    // æ’åºæ¨¡å¼ï¼šæ˜¾ç¤ºæ‹–æ‹½æ‰‹æŸ„ï¼Œå¯æ‹–æ‹½
                    pairElement.innerHTML = `
                        <span class="drag-handle" draggable="true" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">â˜°</span>
                        <span class="pair-name">${pair}</span>
                        <button class="upload-btn" onclick="event.stopPropagation(); uploadForPair('${pair}')">ä¸Šä¼ </button>
                    `;
                    
                    // è®¾ç½®æ‹–æ‹½äº‹ä»¶
                    pairElement.setAttribute('draggable', 'true');
                    pairElement.ondragstart = (e) => handleDragStart(e, index, pair);
                    pairElement.ondragover = handleDragOverPair;
                    pairElement.ondrop = (e) => handleDropPair(e, index);
                    pairElement.ondragleave = handleDragLeavePair;
                } else {
                    // æ­£å¸¸æ¨¡å¼
                    pairElement.innerHTML = `
                        <span class="pair-name">${pair}</span>
                        <button class="upload-btn" onclick="event.stopPropagation(); uploadForPair('${pair}')">ä¸Šä¼ </button>
                    `;
                    pairElement.onclick = () => selectAirportPair(pair);
                }
                
                container.appendChild(pairElement);
            });
            
            // æ›´æ–°å½“å‰æœºåœºå¯¹åç§°æ˜¾ç¤º
            document.getElementById('currentPairName').textContent = currentPair || '-';
            
            // æ¸²æŸ“æœºåœºå¯¹åˆ—è¡¨ï¼ˆåœ¨æ•°æ®ç®¡ç†ä¸­ï¼‰
            renderPairsList();
        }
        
        // æ¸²æŸ“æœºåœºå¯¹åˆ—è¡¨ï¼ˆæ•°æ®ç®¡ç†åŒºåŸŸï¼‰
        function renderPairsList() {
            const container = document.getElementById('pairsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            airportPairs.forEach((pair, index) => {
                const pairData = allData[pair] || { release: [], descend: [], maxAlternates: 5 };
                const totalSegments = pairData.release.length + pairData.descend.length;
                
                const div = document.createElement('div');
                div.className = 'pair-item';
                div.setAttribute('data-index', index);
                div.setAttribute('data-pair', pair);
                
                // è®¾ç½®æ‹–æ‹½äº‹ä»¶ï¼ˆåœ¨æ•°æ®ç®¡ç†åˆ—è¡¨ä¸­ï¼‰
                if (passwordVerified) {
                    div.setAttribute('draggable', 'true');
                    div.ondragstart = (e) => handleDragStartList(e, index, pair);
                    div.ondragover = handleDragOverListItem;
                    div.ondrop = (e) => handleDropListItem(e, index);
                    div.ondragleave = handleDragLeaveListItem;
                }
                
                div.innerHTML = `
                    <div class="pair-info">
                        <span class="drag-handle" draggable="true">â˜°</span>
                        <div>
                            <strong>${pair}</strong>
                            <span style="font-size: 0.8rem; color: #718096; margin-left: 10px;">
                                (é‡Šå‹: ${pairData.release.length} | é£˜é™: ${pairData.descend.length} | å¤‡é™åœº: ${pairData.maxAlternates || 5})
                            </span>
                        </div>
                    </div>
                    <div class="pair-actions">
                        <button onclick="deleteAirportPair('${pair}')" style="padding: 4px 8px; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            åˆ é™¤
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // é€‰æ‹©æœºåœºå¯¹
        function selectAirportPair(pair) {
            if (isReorderMode) return; // åœ¨æ’åºæ¨¡å¼ä¸‹ä¸å“åº”ç‚¹å‡»é€‰æ‹©
            
            currentPair = pair;
            if (allData[pair]) {
                selectedAlternates = allData[pair].selectedAlternates || new Set();
            } else {
                allData[pair] = {
                    release: [],
                    descend: [],
                    selectedAlternates: new Set(),
                    maxAlternates: 5,
                    nextId: 1
                };
                selectedAlternates = new Set();
            }
            
            renderAirportPairs();
            // é‡æ–°è®¡ç®—æœ€å¤§å¤‡é™åœºæ•°
            calculateMaxAlternatesCount();
            renderTableHeader();
            renderTable();
            updateStats();
            showNotification(`å·²åˆ‡æ¢åˆ°æœºåœºå¯¹ï¼š${pair}`);
        }
        
        // åˆ‡æ¢æ’åºæ¨¡å¼
        function togglePairOrderMode() {
            isReorderMode = !isReorderMode;
            
            const orderBtn = document.getElementById('orderModeBtn');
            const dragInstructions = document.getElementById('dragInstructions');
            const listSortControls = document.getElementById('listSortControls');
            
            if (isReorderMode) {
                // è¿›å…¥æ’åºæ¨¡å¼
                orderBtn.innerHTML = '<span class="icon">âœ…</span><span class="text">å®Œæˆæ’åº</span>';
                orderBtn.classList.remove('btn-info');
                orderBtn.classList.add('btn-success');
                dragInstructions.style.display = 'block';
                listSortControls.style.display = 'flex';
                
                // ä¿å­˜åŸå§‹é¡ºåºï¼Œä»¥ä¾¿å–æ¶ˆæ—¶æ¢å¤
                originalPairOrder = [...airportPairs];
                
                showNotification('å·²è¿›å…¥æ’åºæ¨¡å¼ï¼Œæ‹–åŠ¨æœºåœºå¯¹å¯è°ƒæ•´é¡ºåº');
            } else {
                // é€€å‡ºæ’åºæ¨¡å¼
                orderBtn.innerHTML = '<span class="icon">ğŸ”„</span><span class="text">è°ƒæ•´é¡ºåº</span>';
                orderBtn.classList.remove('btn-success');
                orderBtn.classList.add('btn-info');
                dragInstructions.style.display = 'none';
                listSortControls.style.display = 'none';
                
                // ä¿å­˜å½“å‰é¡ºåº
                saveAllData();
                showNotification('å·²é€€å‡ºæ’åºæ¨¡å¼ï¼Œé¡ºåºå·²ä¿å­˜');
            }
            
            renderAirportPairs();
        }
        
        // ä¿å­˜æœºåœºå¯¹é¡ºåº
        function savePairOrder() {
            saveAllData();
            isReorderMode = false;
            
            const orderBtn = document.getElementById('orderModeBtn');
            const dragInstructions = document.getElementById('dragInstructions');
            const listSortControls = document.getElementById('listSortControls');
            
            orderBtn.innerHTML = '<span class="icon">ğŸ”„</span><span class="text">è°ƒæ•´é¡ºåº</span>';
            orderBtn.classList.remove('btn-success');
            orderBtn.classList.add('btn-info');
            dragInstructions.style.display = 'none';
            listSortControls.style.display = 'none';
            
            showNotification('æœºåœºå¯¹é¡ºåºå·²ä¿å­˜');
            renderAirportPairs();
        }
        
        // å–æ¶ˆæ’åºï¼Œæ¢å¤åŸå§‹é¡ºåº
        function cancelPairOrder() {
            if (originalPairOrder.length > 0) {
                airportPairs = [...originalPairOrder];
                renderAirportPairs();
                showNotification('å·²æ¢å¤åŸå§‹é¡ºåº');
            }
            
            isReorderMode = false;
            const orderBtn = document.getElementById('orderModeBtn');
            const dragInstructions = document.getElementById('dragInstructions');
            const listSortControls = document.getElementById('listSortControls');
            
            orderBtn.innerHTML = '<span class="icon">ğŸ”„</span><span class="text">è°ƒæ•´é¡ºåº</span>';
            orderBtn.classList.remove('btn-success');
            orderBtn.classList.add('btn-info');
            dragInstructions.style.display = 'none';
            listSortControls.style.display = 'none';
        }
        
        // æ‹–æ‹½åŠŸèƒ½ - æœºåœºå¯¹æŒ‰é’®åŒºåŸŸ
        function handleDragStart(e, index, pair) {
            draggedItem = pair;
            draggedItemIndex = index;
            e.dataTransfer.setData('text/plain', pair);
            e.dataTransfer.effectAllowed = 'move';
            
            const element = e.target.closest('.airport-pair');
            if (element) {
                element.classList.add('dragging');
                setTimeout(() => element.classList.add('dragging'), 0);
            }
        }
        
        function handleDragOverPair(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const element = e.target.closest('.airport-pair');
            if (element && element !== draggedItem) {
                element.classList.add('drag-over');
            }
        }
        
        function handleDragLeavePair(e) {
            const element = e.target.closest('.airport-pair');
            if (element) {
                element.classList.remove('drag-over');
            }
        }
        
        function handleDropPair(e, dropIndex) {
            e.preventDefault();
            
            const element = e.target.closest('.airport-pair');
            if (element) {
                element.classList.remove('drag-over');
            }
            
            if (draggedItem !== null && draggedItemIndex !== dropIndex) {
                // ä»æ•°ç»„ä¸­ç§»é™¤æ‹–æ‹½çš„é¡¹ç›®
                airportPairs.splice(draggedItemIndex, 1);
                
                // åœ¨ç›®æ ‡ä½ç½®æ’å…¥
                airportPairs.splice(dropIndex, 0, draggedItem);
                
                // é‡æ–°æ¸²æŸ“
                renderAirportPairs();
                
                // é‡ç½®æ‹–æ‹½çŠ¶æ€
                setTimeout(() => {
                    const draggingElements = document.querySelectorAll('.airport-pair.dragging');
                    draggingElements.forEach(el => el.classList.remove('dragging'));
                }, 0);
            }
        }
        
        function handleDragEnd(e) {
            const elements = document.querySelectorAll('.airport-pair.drag-over, .airport-pair.dragging');
            elements.forEach(el => {
                el.classList.remove('drag-over');
                el.classList.remove('dragging');
            });
            
            draggedItem = null;
            draggedItemIndex = -1;
        }
        
        // æ‹–æ‹½åŠŸèƒ½ - æ•°æ®ç®¡ç†åˆ—è¡¨
        function handleDragStartList(e, index, pair) {
            if (!passwordVerified) return;
            
            draggedItem = pair;
            draggedItemIndex = index;
            e.dataTransfer.setData('text/plain', pair);
            e.dataTransfer.effectAllowed = 'move';
            
            const element = e.target.closest('.pair-item');
            if (element) {
                element.classList.add('dragging');
            }
        }
        
        function handleDragOverListItem(e) {
            if (!passwordVerified) return;
            
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleDragLeaveListItem(e) {
            // ä¸éœ€è¦ç‰¹æ®Šå¤„ç†
        }
        
        function handleDropListItem(e, dropIndex) {
            if (!passwordVerified) return;
            
            e.preventDefault();
            
            if (draggedItem !== null && draggedItemIndex !== dropIndex) {
                // ä»æ•°ç»„ä¸­ç§»é™¤æ‹–æ‹½çš„é¡¹ç›®
                airportPairs.splice(draggedItemIndex, 1);
                
                // åœ¨ç›®æ ‡ä½ç½®æ’å…¥
                airportPairs.splice(dropIndex, 0, draggedItem);
                
                // é‡æ–°æ¸²æŸ“
                renderAirportPairs();
                renderPairsList();
                
                // é‡ç½®æ‹–æ‹½çŠ¶æ€
                const draggingElements = document.querySelectorAll('.pair-item.dragging');
                draggingElements.forEach(el => el.classList.remove('dragging'));
            }
        }
        
        // ==================== æ•°æ®åŒæ­¥åŠŸèƒ½ ====================
        
        // å¯¼å‡ºæ‰€æœ‰æ•°æ®ä¸ºJSONæ–‡ä»¶
        function exportAllData() {
            const data = {
                version: DATA_VERSION,
                airportPairs: airportPairs,
                allData: {},
                currentPair: currentPair,
                exportTime: new Date().toISOString(),
                dataCount: 0
            };
            
            let totalSegments = 0;
            // è½¬æ¢Setä¸ºæ•°ç»„ä»¥ä¾¿å­˜å‚¨
            Object.keys(allData).forEach(pair => {
                data.allData[pair] = {
                    release: allData[pair].release,
                    descend: allData[pair].descend,
                    selectedAlternates: Array.from(allData[pair].selectedAlternates || []),
                    maxAlternates: allData[pair].maxAlternates || 5,
                    nextId: allData[pair].nextId
                };
                totalSegments += (allData[pair].release?.length || 0) + (allData[pair].descend?.length || 0);
            });
            
            data.dataCount = totalSegments;
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            link.download = `NSé£è¡Œæ•°æ®_${dateStr}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // è®°å½•å¤‡ä»½æ—¶é—´
            localStorage.setItem('nsLastBackup', Date.now().toString());
            updateLastBackupInfo();
            
            showNotification(`æ•°æ®å·²å¯¼å‡ºï¼ŒåŒ…å«${airportPairs.length}ä¸ªæœºåœºå¯¹ï¼Œ${totalSegments}æ¡æ•°æ®`);
        }
        
        // å¯¼å…¥æ•°æ®æ–‡ä»¶
        function importData() {
            if (!passwordVerified) {
                showNotification('è¯·å…ˆéªŒè¯å¯†ç ä»¥è®¿é—®æ­¤åŠŸèƒ½', 'error');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // éªŒè¯æ•°æ®æ ¼å¼
                        if (!validateImportedData(importedData)) {
                            showNotification('æ•°æ®æ ¼å¼ä¸æ­£ç¡®', 'error');
                            return;
                        }
                        
                        // ç¡®è®¤æ˜¯å¦è¦†ç›–
                        if (!confirm(`å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼ŒåŒ…å«${importedData.airportPairs?.length || 0}ä¸ªæœºåœºå¯¹ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                            return;
                        }
                        
                        // æ¸…ç©ºç°æœ‰æ•°æ®
                        allData = {};
                        airportPairs = [];
                        selectedAlternates = new Set();
                        
                        // å¯¼å…¥æ•°æ®
                        airportPairs = importedData.airportPairs || [];
                        currentPair = importedData.currentPair || (airportPairs.length > 0 ? airportPairs[0] : null);
                        
                        // æ¢å¤æ•°æ®ï¼Œè½¬æ¢æ•°ç»„ä¸ºSet
                        if (importedData.allData) {
                            Object.keys(importedData.allData).forEach(pair => {
                                allData[pair] = {
                                    release: importedData.allData[pair].release || [],
                                    descend: importedData.allData[pair].descend || [],
                                    selectedAlternates: new Set(importedData.allData[pair].selectedAlternates || []),
                                    maxAlternates: importedData.allData[pair].maxAlternates || 5,
                                    nextId: importedData.allData[pair].nextId || 1
                                };
                            });
                        }
                        
                        if (currentPair && allData[currentPair]) {
                            selectedAlternates = allData[currentPair].selectedAlternates || new Set();
                        }
                        
                        renderAirportPairs();
                        // é‡æ–°è®¡ç®—æœ€å¤§å¤‡é™åœºæ•°
                        calculateMaxAlternatesCount();
                        renderTableHeader();
                        renderTable();
                        updateStats();
                        saveAllData();
                        updateLastBackupInfo();
                        
                        showNotification(`æˆåŠŸå¯¼å…¥${airportPairs.length}ä¸ªæœºåœºå¯¹çš„æ•°æ®`);
                        
                    } catch (error) {
                        console.error('å¯¼å…¥é”™è¯¯:', error);
                        showNotification(`å¯¼å…¥å¤±è´¥: ${error.message}`, 'error');
                    }
                };
                
                reader.onerror = function() {
                    showNotification('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // éªŒè¯å¯¼å…¥çš„æ•°æ®æ ¼å¼
        function validateImportedData(data) {
            if (!data) return false;
            if (!Array.isArray(data.airportPairs)) return false;
            if (!data.allData || typeof data.allData !== 'object') return false;
            return true;
        }
        
        // ç”Ÿæˆå¤‡ä»½ä»£ç ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰
        function generateBackupCode() {
            if (!passwordVerified) {
                showNotification('è¯·å…ˆéªŒè¯å¯†ç ä»¥è®¿é—®æ­¤åŠŸèƒ½', 'error');
                return;
            }
            
            const data = {
                version: DATA_VERSION,
                airportPairs: airportPairs,
                allData: {},
                currentPair: currentPair,
                exportTime: new Date().toLocaleString(),
                dataCount: 0
            };
            
            let totalSegments = 0;
            Object.keys(allData).forEach(pair => {
                const pairData = allData[pair];
                data.allData[pair] = {
                    release: pairData.release,
                    descend: pairData.descend,
                    selectedAlternates: Array.from(pairData.selectedAlternates || []),
                    maxAlternates: pairData.maxAlternates || 5,
                    nextId: pairData.nextId
                };
                totalSegments += (pairData.release?.length || 0) + (pairData.descend?.length || 0);
            });
            
            data.dataCount = totalSegments;
            
            const dataStr = JSON.stringify(data, null, 2);
            
            // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºä»£ç 
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">ğŸ“‹ å¤‡ä»½ä»£ç </h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    
                    <div class="data-info">
                        <p>åŒ…å« ${airportPairs.length} ä¸ªæœºåœºå¯¹ï¼Œå…± ${totalSegments} æ¡æ•°æ®</p>
                        <p>æœ€å¤§å¤‡é™åœºæ•°: ${maxAlternatesCount}</p>
                        <p>å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <textarea class="backup-textarea" id="backupCodeText">${dataStr}</textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button onclick="copyBackupCode()" class="btn-success" style="padding: 8px 16px;">ğŸ“‹ å¤åˆ¶ä»£ç </button>
                        <button onclick="this.closest('.modal-overlay').remove()" class="btn-secondary" style="padding: 8px 16px;">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // å¤åˆ¶å¤‡ä»½ä»£ç 
        function copyBackupCode() {
            const textarea = document.getElementById('backupCodeText');
            if (!textarea) return;
            
            textarea.select();
            textarea.setSelectionRange(0, 99999); // å¯¹äºç§»åŠ¨è®¾å¤‡
            document.execCommand('copy');
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
            const copyBtn = document.querySelector('button[onclick="copyBackupCode()"]');
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = 'âœ… å·²å¤åˆ¶';
            copyBtn.disabled = true;
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.disabled = false;
            }, 2000);
            
            showNotification('å¤‡ä»½ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }
        
        // ä»æ–‡æœ¬å¯¼å…¥æ•°æ®
        function importFromText() {
            if (!passwordVerified) {
                showNotification('è¯·å…ˆéªŒè¯å¯†ç ä»¥è®¿é—®æ­¤åŠŸèƒ½', 'error');
                return;
            }
            
            const text = prompt('è¯·ç²˜è´´å¤‡ä»½ä»£ç :');
            if (!text) return;
            
            try {
                const importedData = JSON.parse(text);
                
                // éªŒè¯æ•°æ®
                if (!validateImportedData(importedData)) {
                    showNotification('å¤‡ä»½ä»£ç æ ¼å¼ä¸æ­£ç¡®', 'error');
                    return;
                }
                
                if (!confirm(`ç¡®è®¤å¯¼å…¥ ${importedData.airportPairs?.length || 0} ä¸ªæœºåœºå¯¹çš„æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰æ•°æ®ã€‚`)) {
                    return;
                }
                
                // æ¸…ç©ºç°æœ‰æ•°æ®
                allData = {};
                airportPairs = [];
                selectedAlternates = new Set();
                
                // å¯¼å…¥æ•°æ®
                airportPairs = importedData.airportPairs || [];
                currentPair = importedData.currentPair || (airportPairs.length > 0 ? airportPairs[0] : null);
                
                // æ¢å¤æ•°æ®ï¼Œè½¬æ¢æ•°ç»„ä¸ºSet
                if (importedData.allData) {
                    Object.keys(importedData.allData).forEach(pair => {
                        allData[pair] = {
                            release: importedData.allData[pair].release || [],
                            descend: importedData.allData[pair].descend || [],
                            selectedAlternates: new Set(importedData.allData[pair].selectedAlternates || []),
                            maxAlternates: importedData.allData[pair].maxAlternates || 5,
                            nextId: importedData.allData[pair].nextId || 1
                        };
                    });
                }
                
                if (currentPair && allData[currentPair]) {
                    selectedAlternates = allData[currentPair].selectedAlternates || new Set();
                }
                
                renderAirportPairs();
                // é‡æ–°è®¡ç®—æœ€å¤§å¤‡é™åœºæ•°
                calculateMaxAlternatesCount();
                renderTableHeader();
                renderTable();
                updateStats();
                saveAllData();
                updateLastBackupInfo();
                
                showNotification(`æˆåŠŸå¯¼å…¥ ${airportPairs.length} ä¸ªæœºåœºå¯¹çš„æ•°æ®`);
                
            } catch (error) {
                console.error('å¯¼å…¥é”™è¯¯:', error);
                showNotification(`å¯¼å…¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ›´æ–°æœ€åå¤‡ä»½ä¿¡æ¯
        function updateLastBackupInfo() {
            const lastBackupTime = localStorage.getItem('nsLastBackup');
            const backupInfo = document.getElementById('lastBackupInfo');
            
            if (!backupInfo) return;
            
            if (!lastBackupTime) {
                backupInfo.innerHTML = '<span style="color: #e53e3e;">ä»æœªå¤‡ä»½</span>';
            } else {
                const lastBackupDate = new Date(parseInt(lastBackupTime));
                const now = new Date();
                const diffDays = Math.floor((now - lastBackupDate) / (1000 * 60 * 60 * 24));
                
                let status = 'ğŸŸ¢';
                let color = '#38a169';
                
                if (diffDays > 30) {
                    status = 'ğŸ”´';
                    color = '#e53e3e';
                } else if (diffDays > 7) {
                    status = 'ğŸŸ¡';
                    color = '#d69e2e';
                }
                
                backupInfo.innerHTML = `
                    <span style="color: ${color};">
                        ${status} æœ€åå¤‡ä»½: ${lastBackupDate.toLocaleDateString()} (${diffDays}å¤©å‰)
                    </span>
                `;
            }
        }
        
        // æ£€æŸ¥å¤‡ä»½æé†’
        function checkBackupReminder() {
            const lastBackupTime = localStorage.getItem('nsLastBackup');
            if (!lastBackupTime) {
                // ä»æœªå¤‡ä»½ï¼Œé¦–æ¬¡ä½¿ç”¨æé†’
                setTimeout(() => {
                    if (confirm('å»ºè®®ç«‹å³å¤‡ä»½æ•°æ®ï¼Œæ˜¯å¦ç°åœ¨å¤‡ä»½ï¼Ÿ')) {
                        exportAllData();
                    }
                }, 3000);
            } else {
                const lastBackupDate = new Date(parseInt(lastBackupTime));
                const now = new Date();
                const diffDays = Math.floor((now - lastBackupDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays > 7) {
                    setTimeout(() => {
                        if (confirm(`å·²è¶…è¿‡${diffDays}å¤©æœªå¤‡ä»½æ•°æ®ï¼Œå»ºè®®ç«‹å³å¤‡ä»½ã€‚æ˜¯å¦å¤‡ä»½ï¼Ÿ`)) {
                            exportAllData();
                        }
                    }, 5000);
                }
            }
        }
        
        // æ¸²æŸ“è¡¨æ ¼ï¼ˆæŒ‰é‡Šå‹å’Œé£˜é™åˆ†ç»„ï¼ŒåŠ¨æ€è°ƒæ•´åˆ—æ•°ï¼‰
        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (!currentPair || !allData[currentPair]) {
                // æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€
                const emptyRow = document.createElement('tr');
                const colspan = maxAlternatesCount + 1; // +1 æ˜¯èˆªæ®µåˆ—
                emptyRow.innerHTML = `
                    <td colspan="${colspan}" style="padding: 40px; text-align: center; color: #718096;">
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">ğŸ“Š</div>
                        <div>è¯·é€‰æ‹©æœºåœºå¯¹å¹¶ä¸Šä¼ æ•°æ®</div>
                    </td>
                `;
                tableBody.appendChild(emptyRow);
                return;
            }
            
            const pairData = allData[currentPair];
            const hasReleaseData = pairData.release && pairData.release.length > 0;
            const hasDescendData = pairData.descend && pairData.descend.length > 0;
            
            // æ¸²æŸ“é‡Šå‹æ•°æ®
            if (hasReleaseData) {
                // é‡Šå‹ç»„æ ‡é¢˜è¡Œ
                const releaseHeader = document.createElement('tr');
                releaseHeader.className = 'release-group';
                const releaseColspan = maxAlternatesCount + 1;
                releaseHeader.innerHTML = `
                    <td colspan="${releaseColspan}" class="group-title release-group-title">
                        <span class="program-indicator release-indicator">é‡Šå‹ç¨‹åº</span>
                        <span style="font-size: 0.9rem; color: #718096;">(${pairData.release.length}ä¸ªèˆªæ®µ)</span>
                    </td>
                `;
                tableBody.appendChild(releaseHeader);
                
                // é‡Šå‹æ•°æ®è¡Œ
                pairData.release.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'release-group';
                    
                    // æ£€æŸ¥è¯¥è¡Œæ˜¯å¦æœ‰é€‰ä¸­çš„å¤‡é™åœº
                    let hasSelectedAlternate = false;
                    for (let i = 1; i <= maxAlternatesCount; i++) {
                        const key = `alternate${i}`;
                        if (selectedAlternates.has(row[key])) {
                            hasSelectedAlternate = true;
                            break;
                        }
                    }
                    
                    let rowHTML = `
                        <td class="segment-cell ${hasSelectedAlternate ? 'selected' : ''}">
                            ${row.segment}
                        </td>
                    `;
                    
                    // åŠ¨æ€ç”Ÿæˆå¤‡é™åœºå•å…ƒæ ¼
                    for (let i = 1; i <= maxAlternatesCount; i++) {
                        const key = `alternate${i}`;
                        const value = row[key] || '';
                        rowHTML += `
                            <td class="alternate-cell ${selectedAlternates.has(value) ? 'selected' : ''}" 
                                data-alternate="${value}"
                                onclick="toggleAlternateHighlight('${value}')">
                                ${value || '-'}
                            </td>
                        `;
                    }
                    
                    tr.innerHTML = rowHTML;
                    tableBody.appendChild(tr);
                });
            }
            
            // ç»„é—´åˆ†éš”çº¿ï¼ˆå¦‚æœæœ‰é‡Šå‹å’Œé£˜é™æ•°æ®ï¼‰
            if (hasReleaseData && hasDescendData) {
                const divider = document.createElement('tr');
                divider.className = 'group-divider';
                const dividerColspan = maxAlternatesCount + 1;
                divider.innerHTML = `<td colspan="${dividerColspan}"></td>`;
                tableBody.appendChild(divider);
            }
            
            // æ¸²æŸ“é£˜é™æ•°æ®
            if (hasDescendData) {
                // é£˜é™ç»„æ ‡é¢˜è¡Œ
                const descendHeader = document.createElement('tr');
                descendHeader.className = 'descend-group';
                const descendColspan = maxAlternatesCount + 1;
                descendHeader.innerHTML = `
                    <td colspan="${descendColspan}" class="group-title descend-group-title">
                        <span class="program-indicator descend-indicator">é£˜é™ç¨‹åº</span>
                        <span style="font-size: 0.9rem; color: #718096;">(${pairData.descend.length}ä¸ªèˆªæ®µ)</span>
                    </td>
                `;
                tableBody.appendChild(descendHeader);
                
                // é£˜é™æ•°æ®è¡Œ
                pairData.descend.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'descend-group';
                    
                    // æ£€æŸ¥è¯¥è¡Œæ˜¯å¦æœ‰é€‰ä¸­çš„å¤‡é™åœº
                    let hasSelectedAlternate = false;
                    for (let i = 1; i <= maxAlternatesCount; i++) {
                        const key = `alternate${i}`;
                        if (selectedAlternates.has(row[key])) {
                            hasSelectedAlternate = true;
                            break;
                        }
                    }
                    
                    let rowHTML = `
                        <td class="segment-cell ${hasSelectedAlternate ? 'selected' : ''}">
                            ${row.segment}
                        </td>
                    `;
                    
                    // åŠ¨æ€ç”Ÿæˆå¤‡é™åœºå•å…ƒæ ¼
                    for (let i = 1; i <= maxAlternatesCount; i++) {
                        const key = `alternate${i}`;
                        const value = row[key] || '';
                        rowHTML += `
                            <td class="alternate-cell ${selectedAlternates.has(value) ? 'selected' : ''}" 
                                data-alternate="${value}"
                                onclick="toggleAlternateHighlight('${value}')">
                                ${value || '-'}
                            </td>
                        `;
                    }
                    
                    tr.innerHTML = rowHTML;
                    tableBody.appendChild(tr);
                });
            }
            
            // å¦‚æœæ²¡æœ‰æ•°æ®
            if (!hasReleaseData && !hasDescendData) {
                const emptyRow = document.createElement('tr');
                const colspan = maxAlternatesCount + 1;
                emptyRow.innerHTML = `
                    <td colspan="${colspan}" style="padding: 40px; text-align: center; color: #718096;">
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">ğŸ“­</div>
                        <div>å½“å‰æœºåœºå¯¹æš‚æ— æ•°æ®ï¼Œè¯·ä¸Šä¼ CSVæ–‡ä»¶</div>
                    </td>
                `;
                tableBody.appendChild(emptyRow);
            }
            
            updateSelectedAlternatesDisplay();
        }
        
        // åˆ‡æ¢å¤‡é™åœºé«˜äº®çŠ¶æ€
        function toggleAlternateHighlight(alternateCode) {
            if (!alternateCode || alternateCode.trim() === '' || alternateCode === '-') return;
            
            if (selectedAlternates.has(alternateCode)) {
                selectedAlternates.delete(alternateCode);
            } else {
                selectedAlternates.add(alternateCode);
            }
            
            // ä¿å­˜åˆ°å½“å‰æœºåœºå¯¹çš„æ•°æ®ä¸­
            if (currentPair && allData[currentPair]) {
                allData[currentPair].selectedAlternates = selectedAlternates;
            }
            
            renderTable();
            updateStats();
            saveAllData();
        }
        
        // æ›´æ–°å·²é€‰å¤‡é™åœºæ˜¾ç¤º
        function updateSelectedAlternatesDisplay() {
            const container = document.getElementById('selectedAlternatesContainer');
            container.innerHTML = '';
            
            selectedAlternates.forEach(code => {
                const tag = document.createElement('div');
                tag.className = 'alternate-tag';
                tag.innerHTML = `
                    ğŸ›¬ ${code}
                    <button class="remove" onclick="toggleAlternateHighlight('${code}')">Ã—</button>
                `;
                container.appendChild(tag);
            });
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            if (!currentPair || !allData[currentPair]) {
                document.getElementById('totalSegments').textContent = '0';
                document.getElementById('selectedAlternatesCount').textContent = '0';
                document.getElementById('maxAlternatesCount').textContent = '5';
                return;
            }
            
            const pairData = allData[currentPair];
            const totalSegments = (pairData.release?.length || 0) + (pairData.descend?.length || 0);
            
            document.getElementById('totalSegments').textContent = totalSegments;
            document.getElementById('selectedAlternatesCount').textContent = selectedAlternates.size;
            document.getElementById('currentPairName').textContent = currentPair;
            document.getElementById('maxAlternatesCount').textContent = maxAlternatesCount;
        }
        
        // æ·»åŠ æœºåœºå¯¹
        function addAirportPair() {
            // æ£€æŸ¥å¯†ç éªŒè¯çŠ¶æ€
            if (!passwordVerified) {
                showNotification('è¯·å…ˆéªŒè¯å¯†ç ä»¥è®¿é—®æ­¤åŠŸèƒ½', 'error');
                return;
            }
            
            const input = document.getElementById('newAirportPair');
            const pair = input.value.trim();
            
            if (!pair) {
                showNotification('è¯·è¾“å…¥æœºåœºå¯¹åç§°', 'error');
                return;
            }
            
            if (!pair.includes('-')) {
                showNotification('æœºåœºå¯¹æ ¼å¼åº”ä¸º"èµ·ç‚¹-ç»ˆç‚¹"ï¼Œä¾‹å¦‚ï¼šçŸ³å®¶åº„-å¤§å…´', 'error');
                return;
            }
            
            if (airportPairs.includes(pair)) {
                showNotification('è¯¥æœºåœºå¯¹å·²å­˜åœ¨', 'error');
                return;
            }
            
            airportPairs.push(pair);
            allData[pair] = {
                release: [],
                descend: [],
                selectedAlternates: new Set(),
                maxAlternates: 5,
                nextId: 1
            };
            
            input.value = '';
            renderAirportPairs();
            saveAllData();
            showNotification(`å·²æ·»åŠ æœºåœºå¯¹ï¼š${pair}`);
        }
        
        // æ·»åŠ ç¤ºä¾‹æœºåœºå¯¹
        function addSamplePairs() {
            // æ£€æŸ¥å¯†ç éªŒè¯çŠ¶æ€
            if (!passwordVerified) {
                showNotification('è¯·å…ˆéªŒè¯å¯†ç ä»¥è®¿é—®æ­¤åŠŸèƒ½', 'error');
                return;
            }
            
            const samplePairs = ['æˆéƒ½-é‡åº†', 'é‡åº†-æ˜†æ˜', 'æ˜†æ˜-æˆéƒ½', 'è¥¿å®‰-éƒ‘å·', 'éƒ‘å·-æ­¦æ±‰'];
            
            samplePairs.forEach(pair => {
                if (!airportPairs.includes(pair)) {
                    airportPairs.push(pair);
                    allData[pair] = {
                        release: [],
                        descend: [],
                        selectedAlternates: new Set(),
                        maxAlternates: 5,
                        nextId: 1
                    };
                }
            });
            
            renderAirportPairs();
            saveAllData();
            showNotification(`å·²æ·»åŠ ${samplePairs.length}ä¸ªç¤ºä¾‹æœºåœºå¯¹`);
        }
        
        // åˆ é™¤æœºåœºå¯¹
        function deleteAirportPair(pair) {
            // æ£€æŸ¥å¯†ç éªŒè¯çŠ¶æ€
            if (!passwordVerified) {
                showNotification('è¯·å…ˆéªŒè¯å¯†ç ä»¥è®¿é—®æ­¤åŠŸèƒ½', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æœºåœºå¯¹"${pair}"åŠå…¶æ‰€æœ‰æ•°æ®å—ï¼Ÿ`)) {
                return;
            }
            
            const index = airportPairs.indexOf(pair);
            if (index !== -1) {
                airportPairs.splice(index, 1);
            }
            
            delete allData[pair];
            
            if (currentPair === pair) {
                currentPair = airportPairs.length > 0 ? airportPairs[0] : null;
                if (currentPair) {
                    selectedAlternates = allData[currentPair].selectedAlternates || new Set();
                } else {
                    selectedAlternates = new Set();
                }
            }
            
            renderAirportPairs();
            // é‡æ–°è®¡ç®—æœ€å¤§å¤‡é™åœºæ•°
            calculateMaxAlternatesCount();
            renderTableHeader();
            renderTable();
            updateStats();
            saveAllData();
            showNotification(`å·²åˆ é™¤æœºåœºå¯¹ï¼š${pair}`);
        }
        
        // ä¸ºæŒ‡å®šæœºåœºå¯¹ä¸Šä¼ æ•°æ®
        function uploadForPair(pair) {
            // æ£€æŸ¥å¯†ç éªŒè¯çŠ¶æ€
            if (!passwordVerified) {
                showNotification('è¯·å…ˆéªŒè¯å¯†ç ä»¥è®¿é—®æ­¤åŠŸèƒ½', 'error');
                return;
            }
            
            // ä¸´æ—¶å­˜å‚¨è¦ä¸Šä¼ çš„æœºåœºå¯¹
            window.tempUploadPair = pair;
            document.getElementById('fileInput').click();
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect() {
            // æ£€æŸ¥å¯†ç éªŒè¯çŠ¶æ€
            if (!passwordVerified) {
                showNotification('è¯·å…ˆéªŒè¯å¯†ç ä»¥è®¿é—®æ­¤åŠŸèƒ½', 'error');
                return;
            }
            
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (!files || files.length === 0) {
                return;
            }
            
            // å¦‚æœæœ‰ä¸´æ—¶æŒ‡å®šçš„æœºåœºå¯¹ï¼Œä½¿ç”¨å®ƒï¼Œå¦åˆ™ä½¿ç”¨å½“å‰é€‰ä¸­çš„æœºåœºå¯¹
            const targetPair = window.tempUploadPair || currentPair;
            delete window.tempUploadPair;
            
            if (!targetPair) {
                showNotification('è¯·å…ˆé€‰æ‹©æœºåœºå¯¹', 'error');
                return;
            }
            
            // å¤„ç†æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶
            Array.from(files).forEach(file => {
                processCSVFile(file, targetPair);
            });
            
            // æ¸…é™¤æ–‡ä»¶è¾“å…¥
            fileInput.value = '';
        }
        
        // å¤„ç†CSVæ–‡ä»¶ - æ”¯æŒè‡ªé€‚åº”åˆ—æ•°å’ŒALTNæ ¼å¼åˆ—å
        function processCSVFile(file, targetPair) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let content = e.target.result;
                    
                    // æ£€æµ‹å¹¶ç§»é™¤UTF-8 BOM
                    if (content.charCodeAt(0) === 0xFEFF) {
                        content = content.substring(1);
                    }
                    
                    // è§£æCSV
                    const rows = parseCSV(content);
                    if (rows.length < 2) {
                        showNotification(`æ–‡ä»¶"${file.name}"ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯`, 'error');
                        return;
                    }
                    
                    // è·å–è¡¨å¤´
                    const headers = rows[0];
                    if (headers.length < 2) {
                        showNotification(`æ–‡ä»¶"${file.name}"åˆ—æ•°ä¸è¶³`, 'error');
                        return;
                    }
                    
                    // ç¡®å®šæ˜¯é‡Šå‹è¿˜æ˜¯é£˜é™æ•°æ®
                    const fileName = file.name.toLowerCase();
                    const isRelease = fileName.includes('é‡Šå‹') || fileName.includes('release');
                    const isDescend = fileName.includes('é£˜é™') || fileName.includes('descend');
                    const programType = isRelease ? 'release' : (isDescend ? 'descend' : null);
                    
                    if (!programType) {
                        showNotification(`æ— æ³•ç¡®å®šç¨‹åºç±»å‹ï¼Œè¯·ç¡®è®¤æ–‡ä»¶ååŒ…å«"é‡Šå‹"æˆ–"é£˜é™"`, 'error');
                        return;
                    }
                    
                    // ç¡®ä¿ç›®æ ‡æœºåœºå¯¹å­˜åœ¨
                    if (!allData[targetPair]) {
                        allData[targetPair] = {
                            release: [],
                            descend: [],
                            selectedAlternates: new Set(),
                            maxAlternates: 5,
                            nextId: 1
                        };
                    }
                    
                    // æ¸…ç©ºè¯¥ç¨‹åºç±»å‹ä¸‹çš„æ—§æ•°æ®
                    allData[targetPair][programType] = [];
                    
                    // è®¡ç®—è¯¥æ–‡ä»¶ä¸­çš„æœ€å¤§å¤‡é™åœºåˆ—æ•°
                    let maxColumnsInFile = 0;
                    
                    // è§£ææ•°æ®è¡Œ
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (row.length >= 1 && row[0]) { // è‡³å°‘è¦æœ‰èˆªæ®µåç§°
                            // è®¡ç®—è¯¥è¡Œå®é™…æœ‰æ•°æ®çš„åˆ—æ•°
                            const dataColumns = row.filter(cell => cell && cell.trim() !== '').length;
                            if (dataColumns > maxColumnsInFile) {
                                maxColumnsInFile = dataColumns;
                            }
                            
                            const newRow = {
                                id: allData[targetPair].nextId++,
                                segment: row[0] || `èˆªæ®µ-${i}`
                            };
                            
                            // åŠ¨æ€æ·»åŠ å¤‡é™åœºæ•°æ®ï¼Œæœ€å¤šæ”¯æŒ10ä¸ª
                            // æ”¯æŒä¸¤ç§è¡¨å¤´æ ¼å¼ï¼šèˆªè·¯å¤‡é™åœºX æˆ– ALTNX
                            for (let j = 1; j <= 10; j++) {
                                const key = `alternate${j}`;
                                newRow[key] = row[j] || '';
                            }
                            
                            allData[targetPair][programType].push(newRow);
                        }
                    }
                    
                    // æ›´æ–°è¯¥æœºåœºå¯¹çš„æœ€å¤§å¤‡é™åœºæ•°
                    const currentMax = allData[targetPair].maxAlternates || 5;
                    const fileMax = Math.max(1, maxColumnsInFile - 1); // å‡å»èˆªæ®µåˆ—
                    allData[targetPair].maxAlternates = Math.max(currentMax, fileMax);
                    
                    // é‡æ–°è®¡ç®—å…¨å±€æœ€å¤§å¤‡é™åœºæ•°
                    calculateMaxAlternatesCount();
                    
                    // å¦‚æœå½“å‰æ˜¾ç¤ºçš„å°±æ˜¯è¿™ä¸ªæœºåœºå¯¹ï¼Œåˆ·æ–°è¡¨æ ¼
                    if (currentPair === targetPair) {
                        renderTableHeader();
                        renderTable();
                        updateStats();
                    }
                    
                    // æ›´æ–°æœºåœºå¯¹åˆ—è¡¨æ˜¾ç¤º
                    renderPairsList();
                    
                    saveAllData();
                    showNotification(`å·²å¯¼å…¥${allData[targetPair][programType].length}æ¡${programType === 'release' ? 'é‡Šå‹' : 'é£˜é™'}æ•°æ®åˆ°"${targetPair}"ï¼Œæ£€æµ‹åˆ°${fileMax}ä¸ªå¤‡é™åœºåˆ—`);
                    
                } catch (error) {
                    console.error('CSVè§£æé”™è¯¯:', error);
                    showNotification(`æ–‡ä»¶"${file.name}"è§£æå¤±è´¥: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification(`æ–‡ä»¶"${file.name}"è¯»å–å¤±è´¥`, 'error');
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // è§£æCSVå†…å®¹
        function parseCSV(content) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;
            
            for (let i = 0; i < content.length; i++) {
                const char = content[i];
                const nextChar = content[i + 1];
                
                if (char === '"' && !inQuotes) {
                    inQuotes = true;
                } else if (char === '"' && inQuotes && nextChar === '"') {
                    currentCell += '"';
                    i++; // è·³è¿‡ä¸‹ä¸€ä¸ªå¼•å·
                } else if (char === '"' && inQuotes) {
                    inQuotes = false;
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if (char === '\n' && !inQuotes) {
                    currentRow.push(currentCell.trim());
                    rows.push(currentRow);
                    currentRow = [];
                    currentCell = '';
                } else if (char === '\r' && nextChar === '\n' && !inQuotes) {
                    currentRow.push(currentCell.trim());
                    rows.push(currentRow);
                    currentRow = [];
                    currentCell = '';
                    i++; // è·³è¿‡\n
                } else {
                    currentCell += char;
                }
            }
            
            // æ·»åŠ æœ€åä¸€è¡Œ
            if (currentCell.trim() || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                rows.push(currentRow);
            }
            
            return rows;
        }
        
        // ä¸‹è½½é‡Šå‹æ¨¡æ¿ - ä½¿ç”¨ALTNæ ¼å¼
        function downloadReleaseTemplate() {
            const BOM = '\uFEFF';
            const template = BOM + `èˆªæ®µ,ALTN1,ALTN2,ALTN3,ALTN4,ALTN5,ALTN6,ALTN7,ALTN8,ALTN9,ALTN10
èˆªæ®µ-01,PEK,SHA,CAN,SZX,XIY,CTU,KMG,URC,HRB,DLC
èˆªæ®µ-02,PVG,CTU,KMG,URC,HRB,SHA,PEK,CAN,SZX,XIY
èˆªæ®µ-03,CAN,SZX,CTU,XIY,TAO,PVG,KMG,URC,HRB,PEK`;
            
            const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(template);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', 'NSé‡Šå‹æ¨¡æ¿.csv');
            linkElement.click();
            
            showNotification('é‡Šå‹æ¨¡æ¿å·²ä¸‹è½½ï¼Œæ”¯æŒæœ€å¤š10ä¸ªå¤‡é™åœº(ALTNæ ¼å¼)');
        }
        
        // ä¸‹è½½é£˜é™æ¨¡æ¿ - ä½¿ç”¨ALTNæ ¼å¼
        function downloadDescendTemplate() {
            const BOM = '\uFEFF';
            const template = BOM + `èˆªæ®µ,ALTN1,ALTN2,ALTN3,ALTN4,ALTN5,ALTN6,ALTN7,ALTN8,ALTN9,ALTN10
èˆªæ®µ-04,SZX,CTU,KMG,URC,HRB,PEK,SHA,CAN,XIY,TAO
èˆªæ®µ-05,CTU,PEK,SHA,CAN,SZX,XIY,KMG,URC,HRB,PVG
èˆªæ®µ-06,XIY,CKG,KWE,WUH,CSX,CTU,SZX,CAN,PEK,SHA`;
            
            const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(template);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', 'NSé£˜é™æ¨¡æ¿.csv');
            linkElement.click();
            
            showNotification('é£˜é™æ¨¡æ¿å·²ä¸‹è½½ï¼Œæ”¯æŒæœ€å¤š10ä¸ªå¤‡é™åœº(ALTNæ ¼å¼)');
        }
        
        // ä¸‹è½½å®Œæ•´æ¨¡æ¿ - ä½¿ç”¨ALTNæ ¼å¼
        function downloadCombinedTemplate() {
            const BOM = '\uFEFF';
            const template = BOM + `èˆªæ®µ,ALTN1,ALTN2,ALTN3,ALTN4,ALTN5,ALTN6,ALTN7,ALTN8,ALTN9,ALTN10
èˆªæ®µ-01,PEK,SHA,CAN,SZX,XIY,CTU,KMG,URC,HRB,DLC
èˆªæ®µ-02,PVG,CTU,KMG,URC,HRB,SHA,PEK,CAN,SZX,XIY
èˆªæ®µ-03,CAN,SZX,CTU,XIY,TAO,PVG,KMG,URC,HRB,PEK
èˆªæ®µ-04,SZX,CTU,KMG,URC,HRB,PEK,SHA,CAN,XIY,TAO
èˆªæ®µ-05,CTU,PEK,SHA,CAN,SZX,XIY,KMG,URC,HRB,PVG
èˆªæ®µ-06,XIY,CKG,KWE,WUH,CSX,CTU,SZX,CAN,PEK,SHA`;
            
            const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(template);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', 'NSé‡Šå‹é£˜é™å®Œæ•´æ¨¡æ¿.csv');
            linkElement.click();
            
            showNotification('å®Œæ•´æ¨¡æ¿å·²ä¸‹è½½ï¼Œæ”¯æŒæœ€å¤š10ä¸ªå¤‡é™åœº(ALTNæ ¼å¼)');
        }
        
        // æ‹–æ‹½ä¸Šä¼ å¤„ç†
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileSelect();
            }
        }
        
        // æ¸…ç©ºå½“å‰æœºåœºå¯¹æ•°æ®
        function clearCurrentPairData() {
            // æ£€æŸ¥å¯†ç éªŒè¯çŠ¶æ€
            if (!passwordVerified) {
                showNotification('è¯·å…ˆéªŒè¯å¯†ç ä»¥è®¿é—®æ­¤åŠŸèƒ½', 'error');
                return;
            }
            
            if (!currentPair) {
                showNotification('è¯·å…ˆé€‰æ‹©æœºåœºå¯¹', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦æ¸…ç©º"${currentPair}"çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ`)) {
                return;
            }
            
            if (allData[currentPair]) {
                allData[currentPair].release = [];
                allData[currentPair].descend = [];
                allData[currentPair].selectedAlternates.clear();
                selectedAlternates.clear();
                allData[currentPair].maxAlternates = 5;
                allData[currentPair].nextId = 1;
                
                // é‡æ–°è®¡ç®—å…¨å±€æœ€å¤§å¤‡é™åœºæ•°
                calculateMaxAlternatesCount();
                renderTableHeader();
                renderTable();
                updateStats();
                renderPairsList();
                saveAllData();
                showNotification(`å·²æ¸…ç©º"${currentPair}"çš„æ•°æ®`);
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰æœºåœºå¯¹æ•°æ®
        function clearAllData() {
            // æ£€æŸ¥å¯†ç éªŒè¯çŠ¶æ€
            if (!passwordVerified) {
                showNotification('è¯·å…ˆéªŒè¯å¯†ç ä»¥è®¿é—®æ­¤åŠŸèƒ½', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœºåœºå¯¹çš„æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }
            
            Object.keys(allData).forEach(pair => {
                allData[pair].release = [];
                allData[pair].descend = [];
                allData[pair].selectedAlternates.clear();
                allData[pair].maxAlternates = 5;
                allData[pair].nextId = 1;
            });
            
            if (currentPair && allData[currentPair]) {
                selectedAlternates.clear();
            }
            
            // é‡ç½®æœ€å¤§å¤‡é™åœºæ•°
            maxAlternatesCount = 5;
            document.getElementById('maxAlternatesCount').textContent = maxAlternatesCount;
            document.getElementById('currentColumnsCount').textContent = maxAlternatesCount;
            document.getElementById('columnsInfo').style.display = 'none';
            
            renderTableHeader();
            renderTable();
            updateStats();
            renderPairsList();
            saveAllData();
            showNotification('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®');
        }
        
        // æ¸…é™¤æ‰€æœ‰é«˜äº®
        function clearAllHighlights() {
            if (currentPair && allData[currentPair]) {
                allData[currentPair].selectedAlternates.clear();
                selectedAlternates.clear();
                
                renderTable();
                updateStats();
                saveAllData();
                showNotification('å·²æ¸…é™¤æ‰€æœ‰é«˜äº®');
            }
        }
        
        // åŠ è½½æ‰€æœ‰ç¤ºä¾‹æ•°æ®
        function loadAllSampleData() {
            // æ£€æŸ¥å¯†ç éªŒè¯çŠ¶æ€
            if (!passwordVerified) {
                showNotification('è¯·å…ˆéªŒè¯å¯†ç ä»¥è®¿é—®æ­¤åŠŸèƒ½', 'error');
                return;
            }
            
            airportPairs.forEach(pair => {
                loadPairSampleData(pair);
            });
            
            if (currentPair && allData[currentPair]) {
                selectedAlternates = allData[currentPair].selectedAlternates || new Set();
                // é‡æ–°è®¡ç®—æœ€å¤§å¤‡é™åœºæ•°
                calculateMaxAlternatesCount();
                renderTableHeader();
                renderTable();
                updateStats();
            }
            
            renderPairsList();
            saveAllData();
            showNotification('å·²åŠ è½½æ‰€æœ‰ç¤ºä¾‹æ•°æ®');
        }
        
        // ä¿å­˜æ‰€æœ‰æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveAllData() {
            const saveData = {
                version: DATA_VERSION,
                airportPairs: airportPairs,
                allData: {},
                currentPair: currentPair,
                maxAlternatesCount: maxAlternatesCount,
                saveTime: Date.now()
            };
            
            // è½¬æ¢Setä¸ºæ•°ç»„ä»¥ä¾¿å­˜å‚¨
            Object.keys(allData).forEach(pair => {
                saveData.allData[pair] = {
                    release: allData[pair].release,
                    descend: allData[pair].descend,
                    selectedAlternates: Array.from(allData[pair].selectedAlternates || []),
                    maxAlternates: allData[pair].maxAlternates || 5,
                    nextId: allData[pair].nextId
                };
            });
            
            localStorage.setItem('nsAllData', JSON.stringify(saveData));
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ‰€æœ‰æ•°æ®
        function loadAllData() {
            const savedData = localStorage.getItem('nsAllData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    airportPairs = data.airportPairs || [];
                    currentPair = data.currentPair || (airportPairs.length > 0 ? airportPairs[0] : null);
                    
                    // æ¢å¤å…¨å±€æœ€å¤§å¤‡é™åœºæ•°
                    maxAlternatesCount = data.maxAlternatesCount || 5;
                    
                    // æ¢å¤æ•°æ®ï¼Œè½¬æ¢æ•°ç»„ä¸ºSet
                    allData = {};
                    if (data.allData) {
                        Object.keys(data.allData).forEach(pair => {
                            allData[pair] = {
                                release: data.allData[pair].release || [],
                                descend: data.allData[pair].descend || [],
                                selectedAlternates: new Set(data.allData[pair].selectedAlternates || []),
                                maxAlternates: data.allData[pair].maxAlternates || 5,
                                nextId: data.allData[pair].nextId || 1
                            };
                        });
                    }
                    
                    if (currentPair && allData[currentPair]) {
                        selectedAlternates = allData[currentPair].selectedAlternates || new Set();
                    }
                    
                    updateLastBackupInfo();
                    return true;
                } catch (e) {
                    console.error('åŠ è½½ä¿å­˜çš„æ•°æ®æ—¶å‡ºé”™:', e);
                }
            }
            return false;
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');
            
            messageElement.textContent = message;
            notification.style.backgroundColor = type === 'error' ? '#e53e3e' : '#38a169';
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // åˆ‡æ¢æŠ˜å åŒºåŸŸ
        function toggleCollapse(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById('collapseIcon');
            
            content.classList.toggle('active');
            icon.textContent = content.classList.contains('active') ? 'â–²' : 'â–¼';
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            document.getElementById('uploadArea').addEventListener('click', function(e) {
                if (e.target.type !== 'file') {
                    document.getElementById('fileInput').click();
                }
            });
            
            // è®¾å¤‡æ£€æµ‹
            detectDevice();
            adjustUIForDevice();
            
            // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°æ£€æµ‹è®¾å¤‡
            window.addEventListener('resize', function() {
                detectDevice();
                adjustUIForDevice();
            });
            
            // æ£€æŸ¥å¯†ç éªŒè¯çŠ¶æ€
            checkPasswordFromStorage();
            
            // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
            if (!loadAllData()) {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼ŒåŠ è½½ç¤ºä¾‹æ•°æ®
                initSampleData();
            } else {
                renderAirportPairs();
                if (currentPair) {
                    // æ˜¾ç¤ºåˆ—æ•°ä¿¡æ¯
                    if (maxAlternatesCount > 5) {
                        document.getElementById('columnsInfo').style.display = 'flex';
                        document.getElementById('currentColumnsCount').textContent = maxAlternatesCount;
                    }
                    renderTableHeader();
                    renderTable();
                    updateStats();
                }
            }
            
            // ä¸ºå¯†ç è¾“å…¥æ¡†æ·»åŠ å›è½¦é”®æ”¯æŒ
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
            
            // å»¶è¿Ÿæ£€æŸ¥å¤‡ä»½æé†’
            setTimeout(checkBackupReminder, 1000);
        });
    </script>
</body>
</html>
